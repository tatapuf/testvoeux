<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>L'Atelier des Particules - Mobile</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,300;1,500&family=Montserrat:wght@200;400&display=swap');

        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body { 
            margin: 0; overflow-x: hidden; overflow-y: scroll; 
            background-color: #000; 
            font-family: 'Montserrat', sans-serif;
            -webkit-overflow-scrolling: touch;
        }

        #canvas-container {
            position: fixed; top: 0; left: 0; width: 100%; height: 100vh; z-index: 1;
        }

        #story {
            position: relative; z-index: 10; pointer-events: none;
        }

        .chapter {
            height: 100vh; display: flex; flex-direction: column; justify-content: center; align-items: center;
            padding: 0 8vw; text-align: center; pointer-events: none;
        }

        .chapter-number {
            font-family: 'Montserrat', sans-serif; font-weight: 200; font-size: 0.7rem;
            letter-spacing: 6px; color: rgba(255,255,255,0.4); text-transform: uppercase;
            margin-bottom: 20px; opacity: 0; transform: translateY(20px);
            transition: all 1s ease-out;
        }

        .chapter-title {
            font-family: 'Cormorant Garamond', serif; font-style: italic; font-weight: 500;
            font-size: clamp(2rem, 8vw, 4rem); color: white; line-height: 1.2;
            margin-bottom: 30px; opacity: 0; transform: translateY(30px);
            transition: all 1.2s ease-out 0.15s;
            text-shadow: 0 0 40px rgba(255,255,255,0.3);
        }

        .chapter-text {
            font-family: 'Montserrat', sans-serif; font-weight: 300; 
            font-size: clamp(0.95rem, 2.5vw, 1.2rem);
            color: rgba(255,255,255,0.8); max-width: 500px; line-height: 1.7;
            opacity: 0; transform: translateY(25px);
            transition: all 1.2s ease-out 0.3s;
        }

        .chapter.visible .chapter-number,
        .chapter.visible .chapter-title,
        .chapter.visible .chapter-text {
            opacity: 1; transform: translateY(0);
        }

        .highlight { color: #ffd700; font-style: italic; }

        #intro {
            position: fixed; top: 0; left: 0; width: 100%; height: 100vh; z-index: 3000;
            background: radial-gradient(circle at center, #1a1a1a 0%, #000000 100%);
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            transition: opacity 0.8s ease-out;
        }

        #intro h1 {
            font-family: 'Cormorant Garamond', serif; font-style: italic; color: white;
            font-size: clamp(2rem, 10vw, 4.5rem); text-align: center; margin-bottom: 35px;
            text-shadow: 0 0 50px rgba(255,255,255,0.5); letter-spacing: 1px;
            padding: 0 20px;
        }

        #intro button {
            padding: 18px 50px; background: white; color: black; border: none; font-weight: bold;
            font-size: 1rem; letter-spacing: 3px; text-transform: uppercase; cursor: pointer;
            box-shadow: 0 0 35px rgba(255,255,255,0.6); transition: transform 0.2s; border-radius: 50px;
            pointer-events: all; -webkit-tap-highlight-color: transparent;
        }

        #intro button:active { transform: scale(0.95); }

        #intro.hidden { opacity: 0; pointer-events: none; }

        #scroll-hint {
            position: fixed; bottom: 40px; left: 50%; transform: translateX(-50%);
            color: rgba(255,255,255,0.5); font-size: 0.7rem; letter-spacing: 2px;
            text-transform: uppercase; z-index: 100; animation: float 2s ease-in-out infinite;
            pointer-events: none;
        }

        @keyframes float {
            0%, 100% { transform: translateX(-50%) translateY(0); }
            50% { transform: translateX(-50%) translateY(-8px); }
        }

        #finale {
            height: 100vh; display: flex; align-items: center; justify-content: center;
            background: linear-gradient(to bottom, #000 0%, #1a0033 100%);
        }

        #finale h2 {
            font-family: 'Cormorant Garamond', serif; font-style: italic;
            font-size: clamp(1.8rem, 7vw, 3.5rem); color: white; text-align: center;
            text-shadow: 0 0 60px rgba(170,136,255,0.8); padding: 0 20px;
        }
    </style>
</head>
<body>

    <div id="intro">
        <h1>L'Atelier des Particules</h1>
        <button id="btn-start">COMMENCER</button>
        <div style="margin-top: 18px; color: #666; font-size: 0.8rem; text-align: center; padding: 0 20px;">Optimisé Mobile • Faites défiler</div>
    </div>

    <div id="canvas-container"></div>

    <div id="scroll-hint" style="opacity: 0;">↓ Faites défiler ↓</div>

    <div id="story">
        <div class="chapter" data-shape="chaos">
            <div class="chapter-number">Prologue</div>
            <div class="chapter-title">Au commencement<br>était le <span class="highlight">Chaos</span></div>
            <div class="chapter-text">
                Dans le noir infini, des milliers de particules flottent sans but.
                Elles attendent l'étincelle qui leur donnera un sens.
            </div>
        </div>

        <div class="chapter" data-shape="brain">
            <div class="chapter-number">Chapitre I</div>
            <div class="chapter-title">La <span class="highlight">Cognition</span></div>
            <div class="chapter-text">
                Une idée n'est qu'une particule qui cherche ce avec quoi danser.
                Le cerveau humain, ce nuage électrique qui sculpte la réalité.
            </div>
        </div>

        <div class="chapter" data-shape="dna">
            <div class="chapter-number">Chapitre II</div>
            <div class="chapter-title">L'<span class="highlight">Émotion</span></div>
            <div class="chapter-text">
                La créativité est vivante. Elle se tord, pulse, respire.
                C'est une double hélice qui encode nos rêves les plus profonds.
            </div>
        </div>

        <div class="chapter" data-shape="crystal">
            <div class="chapter-number">Chapitre III</div>
            <div class="chapter-title">La <span class="highlight">Cristallisation</span></div>
            <div class="chapter-text">
                Le chaos se fige. L'idée devient tangible, solide, précieuse.
                Un diamant taillé dans la matière brute de l'imagination.
            </div>
        </div>

        <div class="chapter" data-shape="galaxy">
            <div class="chapter-number">Chapitre IV</div>
            <div class="chapter-title">L'<span class="highlight">Univers</span></div>
            <div class="chapter-text">
                Tu n'es pas spectateur. Tu es le centre de ce monde en expansion.
                Chaque geste sculpte des galaxies entières.
            </div>
        </div>

        <div id="finale">
            <h2>Vous êtes<br>le créateur</h2>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/ScrollTrigger.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/shaders/CopyShader.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/shaders/LuminosityHighPassShader.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/postprocessing/EffectComposer.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/postprocessing/RenderPass.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/postprocessing/ShaderPass.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/postprocessing/UnrealBloomPass.js"></script>

    <script>
        gsap.registerPlugin(ScrollTrigger);

        // DÉTECTION MOBILE/IPHONE
        const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
        const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
        
        // PARTICULES ADAPTATIVES (iPhone = 5000, Desktop = 20000)
        const particleCount = isMobile ? 5000 : 20000;
        
        console.log(`Device: ${isMobile ? 'Mobile' : 'Desktop'}, Particles: ${particleCount}`);

        function getBrightTexture() {
            const c = document.createElement('canvas'); c.width=32; c.height=32;
            const ctx = c.getContext('2d');
            const g = ctx.createRadialGradient(16,16,0, 16,16,16);
            g.addColorStop(0,'rgba(255,255,255,1)');
            g.addColorStop(0.3,'rgba(255,255,255,0.8)');
            g.addColorStop(1,'rgba(0,0,0,0)');
            ctx.fillStyle=g; ctx.fillRect(0,0,32,32);
            return new THREE.CanvasTexture(c);
        }

        // THREE.JS
        const scene = new THREE.Scene();
        scene.fog = new THREE.FogExp2(0x000000, isMobile ? 0.004 : 0.003);

        const camera = new THREE.PerspectiveCamera(60, window.innerWidth/window.innerHeight, 0.1, 2000);
        camera.position.set(0, 0, isMobile ? 180 : 150);

        const renderer = new THREE.WebGLRenderer({ 
            antialias: false, 
            alpha: true,
            powerPreference: isMobile ? "low-power" : "high-performance"
        });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(Math.min(window.devicePixelRatio, isMobile ? 1.5 : 2));
        document.getElementById('canvas-container').appendChild(renderer.domElement);

        // POST-PROCESSING (Bloom réduit sur mobile)
        const composer = new THREE.EffectComposer(renderer);
        composer.addPass(new THREE.RenderPass(scene, camera));
        const bloom = new THREE.UnrealBloomPass(
            new THREE.Vector2(window.innerWidth, window.innerHeight), 
            isMobile ? 1.2 : 2.0,  // Strength
            isMobile ? 0.4 : 0.6,  // Radius
            0.1
        );
        composer.addPass(bloom);

        // FORMES GÉOMÉTRIQUES
        const Shapes = {
            chaos: (i) => ({
                x: (Math.random()-0.5)*400,
                y: (Math.random()-0.5)*400,
                z: (Math.random()-0.5)*400
            }),
            brain: (i) => {
                const r = 45 + Math.random()*12;
                const theta = Math.random() * Math.PI * 2;
                const phi = Math.acos(2 * Math.random() - 1);
                let x = r * Math.sin(phi) * Math.cos(theta);
                let y = r * Math.sin(phi) * Math.sin(theta) * 0.75;
                let z = r * Math.cos(phi);
                x += Math.sign(x) * 10;
                return {x, y, z};
            },
            dna: (i) => {
                const t = (i / particleCount) * Math.PI * 16;
                const r = 28;
                const h = 180;
                const strand = (i % 2 === 0) ? 0 : Math.PI;
                return {
                    x: r * Math.cos(t + strand),
                    z: r * Math.sin(t + strand),
                    y: (i / particleCount) * h - h/2
                };
            },
            crystal: (i) => {
                const size = 50;
                let x = (Math.random()-0.5)*size*2;
                let y = (Math.random()-0.5)*size*2;
                let z = (Math.random()-0.5)*size*2;
                if(Math.abs(x)+Math.abs(y)+Math.abs(z) > size) {
                    const scale = size / (Math.abs(x)+Math.abs(y)+Math.abs(z));
                    x*=scale; y*=scale; z*=scale;
                }
                return {x, y, z};
            },
            galaxy: (i) => {
                const arm = (i % 4) * (2 * Math.PI / 4);
                const dist = Math.pow(Math.random(), 1.5);
                const angle = dist * 13;
                const r = dist * 110;
                return {
                    x: r * Math.cos(angle + arm),
                    y: (Math.random()-0.5) * 16 * (1-dist),
                    z: r * Math.sin(angle + arm)
                };
            }
        };

        // GÉOMÉTRIE
        const geo = new THREE.BufferGeometry();
        const pos = new Float32Array(particleCount*3);
        const target = new Float32Array(particleCount*3);
        const randoms = new Float32Array(particleCount);

        for(let i=0; i<particleCount; i++){
            const chaos = Shapes.chaos(i);
            pos[i*3] = chaos.x;
            pos[i*3+1] = chaos.y;
            pos[i*3+2] = chaos.z;
            randoms[i] = Math.random();
        }
        geo.setAttribute('position', new THREE.BufferAttribute(pos, 3));
        geo.setAttribute('target', new THREE.BufferAttribute(target, 3));
        geo.setAttribute('aRandom', new THREE.BufferAttribute(randoms, 1));

        // SHADER (Optimisé mobile)
        const mat = new THREE.ShaderMaterial({
            uniforms: {
                uTime: { value: 0 },
                uColor: { value: new THREE.Color(0x888888) },
                uTexture: { value: getBrightTexture() },
                uRatio: { value: window.devicePixelRatio }
            },
            vertexShader: `
                uniform float uTime;
                uniform float uRatio;
                attribute float aRandom;
                varying float vAlpha;

                void main() {
                    vec3 p = position;

                    // Respiration légère (réduite sur mobile)
                    float breath = sin(uTime * 1.0 + aRandom * 6.0) * 1.2;
                    p += normalize(p) * breath;

                    vec4 mv = modelViewMatrix * vec4(p, 1.0);
                    gl_Position = projectionMatrix * mv;

                    float size = ${isMobile ? '40.0' : '50.0'} + aRandom * ${isMobile ? '25.0' : '30.0'};
                    gl_PointSize = (size * uRatio) / -mv.z;
                    
                    vAlpha = smoothstep(350.0, 50.0, -mv.z);
                }
            `,
            fragmentShader: `
                uniform vec3 uColor;
                uniform sampler2D uTexture;
                varying float vAlpha;
                void main() {
                    vec4 tex = texture2D(uTexture, gl_PointCoord);
                    gl_FragColor = vec4(uColor, tex.a * vAlpha * 1.2);
                }
            `,
            transparent: true, depthWrite: false, blending: THREE.AdditiveBlending
        });
        scene.add(new THREE.Points(geo, mat));

        // COULEURS PAR CHAPITRE
        const colorMap = {
            chaos: 0x666666,
            brain: 0xffcc00,
            dna: 0x0088ff,
            crystal: 0xff3366,
            galaxy: 0xaa88ff
        };

        let currentShape = 'chaos';

        function setShape(shapeName) {
            if(shapeName === currentShape) return;
            currentShape = shapeName;

            const targets = geo.attributes.target.array;
            for(let i=0; i<particleCount; i++) {
                const p = Shapes[shapeName](i);
                targets[i*3] = p.x;
                targets[i*3+1] = p.y;
                targets[i*3+2] = p.z;
            }
            geo.attributes.target.needsUpdate = true;

            gsap.to(mat.uniforms.uColor.value, {
                r: new THREE.Color(colorMap[shapeName]).r,
                g: new THREE.Color(colorMap[shapeName]).g,
                b: new THREE.Color(colorMap[shapeName]).b,
                duration: 2
            });
        }

        // SCROLL TRIGGERS
        document.querySelectorAll('.chapter').forEach((chapter, idx) => {
            const shape = chapter.dataset.shape;

            ScrollTrigger.create({
                trigger: chapter,
                start: 'top 60%',
                end: 'bottom 40%',
                onEnter: () => {
                    setShape(shape);
                    chapter.classList.add('visible');
                },
                onEnterBack: () => {
                    setShape(shape);
                    chapter.classList.add('visible');
                },
                onLeave: () => chapter.classList.remove('visible'),
                onLeaveBack: () => chapter.classList.remove('visible')
            });

            // Zoom caméra progressif
            gsap.to(camera.position, {
                z: (isMobile ? 180 : 150) - idx * (isMobile ? 15 : 20),
                scrollTrigger: {
                    trigger: chapter,
                    start: 'top bottom',
                    end: 'bottom top',
                    scrub: 1
                }
            });
        });

        // ANIMATION LOOP (Optimisé 30fps sur mobile si nécessaire)
        const clock = new THREE.Clock();
        let lastFrame = 0;
        const targetFPS = isMobile ? 30 : 60;
        const frameInterval = 1000 / targetFPS;

        function animate(timestamp) {
            requestAnimationFrame(animate);

            // Limitation FPS sur mobile pour économiser batterie
            if(isMobile && timestamp - lastFrame < frameInterval) return;
            lastFrame = timestamp;

            const dt = clock.getDelta();
            mat.uniforms.uTime.value = clock.getElapsedTime();

            // Morphing CPU
            const posAttr = geo.attributes.position;
            const targetAttr = geo.attributes.target;
            const speed = (isMobile ? 1.8 : 2.2) * dt;

            for(let i=0; i<particleCount; i++) {
                const ix = i*3;
                posAttr.array[ix] += (targetAttr.array[ix] - posAttr.array[ix]) * speed;
                posAttr.array[ix+1] += (targetAttr.array[ix+1] - posAttr.array[ix+1]) * speed;
                posAttr.array[ix+2] += (targetAttr.array[ix+2] - posAttr.array[ix+2]) * speed;
            }
            posAttr.needsUpdate = true;

            // Rotation caméra subtile
            const t = mat.uniforms.uTime.value;
            camera.rotation.z = Math.sin(t*0.06) * 0.02;

            composer.render();
        }

        // START
        document.getElementById('btn-start').addEventListener('click', () => {
            document.getElementById('intro').classList.add('hidden');
            gsap.to('#scroll-hint', {opacity: 1, delay: 1, duration: 1});
            animate(0);
        });

        // RESIZE (Optimisé iOS)
        let resizeTimeout;
        window.addEventListener('resize', () => {
            clearTimeout(resizeTimeout);
            resizeTimeout = setTimeout(() => {
                camera.aspect = window.innerWidth/window.innerHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(window.innerWidth, window.innerHeight);
                composer.setSize(window.innerWidth, window.innerHeight);
            }, 100);
        });

        // iOS SCROLL FIX
        if(isIOS) {
            document.body.style.height = '100%';
            document.documentElement.style.height = '100%';
        }

    </script>
</body>
</html>
