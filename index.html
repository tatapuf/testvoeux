<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>L‚ÄôAtelier des Particules ‚Äî WJSBUTLER & CO (GPGPU Fluid)</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Montserrat:wght@300;400;600&display=swap');

    :root{
      --ink: rgba(255,255,255,.92);
      --muted: rgba(255,255,255,.55);
      --stroke: rgba(255,255,255,.10);
      --glass: rgba(8,10,14,.55);
      --glass2: rgba(8,10,14,.22);
      --shadow: 0 30px 80px rgba(0,0,0,.65);
      --gold: #ffaa00;
    }
    html,body{height:100%;}
    body{
      margin:0; overflow:hidden; background:#000;
      font-family:Montserrat,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      -webkit-tap-highlight-color: transparent;
      color:var(--ink);
    }
    #c{position:absolute; inset:0;}

    #overlay{
      position:absolute; inset:0; z-index:10;
      display:flex; align-items:center; justify-content:center;
      background: radial-gradient(ellipse at center, rgba(0,170,255,.09) 0%, rgba(0,0,0,1) 58%), #000;
      cursor:pointer; user-select:none;
      transition: opacity .9s ease;
    }
    .intro{ text-align:center; padding:24px; width:min(980px,92%); }
    .intro h1{
      margin:0 0 12px;
      font-family:Cinzel,serif;
      font-size:clamp(2.0rem,8vw,4.2rem);
      letter-spacing:.12em;
      text-transform:uppercase;
      text-shadow:0 0 60px rgba(0,170,255,.28), 0 0 22px rgba(255,255,255,.12);
    }
    .intro .sub{
      font-size:.88rem; letter-spacing:.36em; text-transform:uppercase;
      color:var(--muted); margin-bottom:18px;
    }
    .intro .warn{
      margin:16px auto 0;
      max-width: 860px;
      font-size:.82rem; line-height:1.35;
      color:rgba(255,255,255,.58);
      border:1px solid rgba(255,255,255,.10);
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
      padding:14px 16px;
      border-radius:18px;
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      box-shadow: var(--shadow);
    }
    .intro .tap{
      margin-top:18px;
      font-size:.72rem; letter-spacing:.32em; text-transform:uppercase;
      color:rgba(255,255,255,.48);
      display:inline-flex; align-items:center; gap:10px;
      animation:pulse 1.6s ease-in-out infinite;
    }
    .dot{width:9px;height:9px;border-radius:999px;background:var(--gold); box-shadow:0 0 18px rgba(255,170,0,.9);}
    @keyframes pulse{0%,100%{opacity:.55; transform:translateY(0);}50%{opacity:1; transform:translateY(-2px);} }

    #hud{
      position:absolute; left:18px; right:18px; top:16px; z-index:20;
      display:flex; justify-content:space-between; gap:12px; pointer-events:none;
    }
    .badge, .controls{
      pointer-events:auto;
      display:flex; align-items:center; gap:10px;
      padding:10px 14px;
      border-radius:999px;
      background: linear-gradient(180deg, var(--glass), var(--glass2));
      border:1px solid var(--stroke);
      box-shadow: var(--shadow);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
    }
    .brand{
      font-family:Cinzel,serif;
      letter-spacing:.22em;
      text-transform:uppercase;
      font-size:.72rem;
      color:rgba(255,255,255,.88);
      white-space:nowrap;
    }
    .subbrand{
      font-size:.72rem;
      color:rgba(255,255,255,.55);
      letter-spacing:.08em;
      text-transform:uppercase;
    }
    .btn{
      pointer-events:auto;
      border:1px solid rgba(255,255,255,.12);
      background: linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.03));
      color:rgba(255,255,255,.86);
      padding:9px 12px;
      border-radius:12px;
      cursor:pointer;
      user-select:none;
      font-size:.82rem;
    }
    .btn:active{transform: translateY(1px);}

    #caption{
      position:absolute; left:0; right:0; bottom:0; z-index:20;
      height:42%;
      display:flex; align-items:flex-end; justify-content:center;
      padding:0 18px 42px;
      pointer-events:none;
      background: linear-gradient(to top, rgba(0,0,0,.92) 0%, rgba(0,0,0,.60) 35%, rgba(0,0,0,0) 100%);
    }
    .card{
      width:min(980px,96%);
      border-radius:22px;
      background: linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.02));
      border:1px solid rgba(255,255,255,.10);
      box-shadow: var(--shadow);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      padding:18px 18px 14px;
    }
    .chapter{
      font-family:Cinzel,serif;
      letter-spacing:.42em;
      text-transform:uppercase;
      font-size:.70rem;
      color:rgba(255,255,255,.55);
      margin:0 0 10px;
    }
    .line{
      font-family:Cinzel,serif;
      font-size:clamp(1.25rem,4.8vw,2.25rem);
      line-height:1.25;
      text-align:center;
      margin:0;
      text-shadow:0 0 28px rgba(255,255,255,.20);
    }
    .hl{color:var(--gold); text-shadow:0 0 28px rgba(255,170,0,.55);}
    .meta{
      margin-top:12px;
      display:flex; justify-content:space-between; align-items:center; gap:10px;
      font-size:.72rem; letter-spacing:.14em; text-transform:uppercase;
      color:rgba(255,255,255,.48);
    }
    .barwrap{width:190px;height:4px;background:rgba(255,255,255,.12);border-radius:999px;overflow:hidden;}
    .bar{height:100%;width:0%; background: linear-gradient(90deg, rgba(255,170,0,.2), rgba(255,170,0,.95), rgba(0,170,255,.55)); filter: drop-shadow(0 0 12px rgba(255,170,0,.55));}
    @media (max-width:520px){ .barwrap{width:120px;} .btn span{display:none;} }
  </style>
</head>
<body>
  <canvas id="c"></canvas>

  <div id="hud">
    <div class="badge">
      <div>
        <div class="brand">WJSBUTLER & CO</div>
        <div class="subbrand">Hospitalit√© cin√©matique ‚Äî GPGPU</div>
      </div>
    </div>
    <div class="controls">
      <button id="btnQuality" class="btn">‚ö° <span>Qualit√©</span></button>
      <button id="btnBloom" class="btn">‚ú® <span>Bloom</span></button>
      <button id="btnReplay" class="btn">‚ü≤ <span>Rejouer</span></button>
    </div>
  </div>

  <div id="caption">
    <div class="card">
      <div id="chap" class="chapter">I. L‚ÄôOUVERTURE</div>
      <p id="txt" class="line">Ici, tout commence par une <span class="hl">respiration</span>.</p>
      <div class="meta">
        <div>Tap / Espace : sc√®ne suivante</div>
        <div style="display:flex;align-items:center;gap:12px;">
          <div class="barwrap"><div id="bar" class="bar"></div></div>
          <div id="count">01/06</div>
        </div>
      </div>
    </div>
  </div>

  <div id="overlay">
    <div class="intro">
      <h1>L‚ÄôAtelier<br/>des Particules</h1>
      <div class="sub">Simulation GPGPU ‚Äî Curl Noise ‚Äî Post cin√©ma</div>
      <div class="warn">
        <b>Attention :</b> version ‚Äúblockbuster‚Äù. GPU tr√®s sollicit√© (compute + bloom).<br/>
        Utilise <b>Qualit√©</b> si ton appareil chauffe/rame.
      </div>
      <div class="tap"><span class="dot"></span> Touchez pour d√©marrer</div>
    </div>
  </div>

  <script type="module">
    import * as THREE from "https://unpkg.com/three@0.128.0/build/three.module.js";
    import { GPUComputationRenderer } from "https://unpkg.com/three@0.128.0/examples/jsm/misc/GPUComputationRenderer.js";
    import { EffectComposer } from "https://unpkg.com/three@0.128.0/examples/jsm/postprocessing/EffectComposer.js";
    import { RenderPass } from "https://unpkg.com/three@0.128.0/examples/jsm/postprocessing/RenderPass.js";
    import { ShaderPass } from "https://unpkg.com/three@0.128.0/examples/jsm/postprocessing/ShaderPass.js";
    import { UnrealBloomPass } from "https://unpkg.com/three@0.128.0/examples/jsm/postprocessing/UnrealBloomPass.js";
    import { FilmPass } from "https://unpkg.com/three@0.128.0/examples/jsm/postprocessing/FilmPass.js";

    const SETTINGS = {
      SIZE: 192, // 192^2 = 36864 particules
      BOUNDS: 220,
      CAMERA_RADIUS: 190,

      DAMPING: 0.985,
      NOISE_SCALE: 0.0105,
      NOISE_SPEED: 0.22,
      CURL_STRENGTH: 2.25,

      ATTRACT_STRENGTH: 0.08,
      TARGET_BLEND: 0.035,

      POINT_SIZE: 160.0,
      EXPOSURE: 1.22,

      DPR_HIGH: 2.0,
      DPR_LOW: 1.0,
      useHighQuality: true,

      bloomOn: true,
      bloomStrength: 1.35,
      bloomRadius: 0.45,
      bloomThreshold: 0.18,

      rgbShift: 0.0018,
      grainIntensity: 0.22
    };

    const story = [
      { chap:"I. L‚ÄôOUVERTURE", txt:`Ici, tout commence par une <span class="hl">respiration</span>.`, color: new THREE.Color(1.0,0.78,0.25), target:"breath" },
      { chap:"II. LA MATI√àRE", txt:`Une id√©e est une <span class="hl">√©tincelle</span> dans le noir.`, color: new THREE.Color(1.0,0.60,0.12), target:"burst" },
      { chap:"III. L‚Äô√âMOTION", txt:`L‚Äô√©motion est une <span class="hl" style="color:#00aaff;text-shadow:0 0 28px #00aaff">vague</span> qui nous emporte.`, color: new THREE.Color(0.12,0.52,1.0), target:"wave" },
      { chap:"IV. LA CONNEXION", txt:`L‚Äôempathie tisse des <span class="hl" style="color:#ff0055;text-shadow:0 0 28px #ff0055">liens</span> invisibles.`, color: new THREE.Color(1.0,0.10,0.45), target:"dna" },
      { chap:"V. L‚Äô≈íUVRE", txt:`Le chaos devient <span class="hl" style="color:#00ff88;text-shadow:0 0 28px #00ff88">structure</span>.`, color: new THREE.Color(0.20,1.0,0.62), target:"sphere" },
      { chap:"VI. L‚ÄôEMPREINTE", txt:`Et l‚Äôinstant devient <span class="hl" style="color:#c7a2ff;text-shadow:0 0 28px #c7a2ff">m√©moire</span>.`, color: new THREE.Color(0.78,0.55,1.0), target:"galaxy" }
    ];
    let step = 0;

    const chapEl = document.getElementById("chap");
    const txtEl  = document.getElementById("txt");
    const barEl  = document.getElementById("bar");
    const countEl= document.getElementById("count");
    function setUI(i){
      chapEl.textContent = story[i].chap;
      txtEl.innerHTML = story[i].txt;
      barEl.style.width = ((i+1)/story.length*100).toFixed(2) + "%";
      countEl.textContent = String(i+1).padStart(2,"0") + "/" + String(story.length).padStart(2,"0");
    }

    const canvas = document.getElementById("c");
    const renderer = new THREE.WebGLRenderer({ canvas, antialias:false, alpha:false, powerPreference:"high-performance" });
    renderer.setPixelRatio(Math.min(window.devicePixelRatio, SETTINGS.useHighQuality ? SETTINGS.DPR_HIGH : SETTINGS.DPR_LOW));
    renderer.setSize(window.innerWidth, window.innerHeight);
    renderer.outputEncoding = THREE.sRGBEncoding;
    renderer.toneMapping = THREE.ACESFilmicToneMapping;
    renderer.toneMappingExposure = SETTINGS.EXPOSURE;

    const scene = new THREE.Scene();
    scene.fog = new THREE.FogExp2(0x000000, 0.0019);

    const camera = new THREE.PerspectiveCamera(70, window.innerWidth/window.innerHeight, 0.1, 3000);
    camera.position.set(0, 0, SETTINGS.CAMERA_RADIUS);
    scene.add(new THREE.AmbientLight(0xffffff, 0.12));

    const pointer = new THREE.Vector2(0,0);
    window.addEventListener("pointermove", (e)=>{
      pointer.x = (e.clientX / window.innerWidth) * 2 - 1;
      pointer.y = -((e.clientY / window.innerHeight) * 2 - 1);
    }, { passive:true });

    // --- GPGPU
    const SIZE = SETTINGS.SIZE;
    const PARTICLES = SIZE * SIZE;

    const gpuCompute = new GPUComputationRenderer(SIZE, SIZE, renderer);

    // Compatibility: half float is often safer on mobile
    gpuCompute.setDataType(THREE.HalfFloatType);

    const dtPosition = gpuCompute.createTexture();
    const dtVelocity = gpuCompute.createTexture();
    const dtTarget   = gpuCompute.createTexture();

    function fillPosition(texture){
      const data = texture.image.data;
      for(let i=0;i<data.length;i+=4){
        data[i+0] = (Math.random()*2-1) * 8;
        data[i+1] = (Math.random()*2-1) * 8;
        data[i+2] = (Math.random()*2-1) * 8;
        data[i+3] = 1;
      }
    }
    function fillVelocity(texture){
      const data = texture.image.data;
      for(let i=0;i<data.length;i+=4){
        data[i+0] = (Math.random()*2-1) * 0.1;
        data[i+1] = (Math.random()*2-1) * 0.1;
        data[i+2] = (Math.random()*2-1) * 0.1;
        data[i+3] = 1;
      }
    }
    fillPosition(dtPosition);
    fillVelocity(dtVelocity);

    function writeTargetShape(name){
      const data = dtTarget.image.data;
      const N = PARTICLES;

      for(let p=0;p<N;p++){
        const u = p / N;
        let x=0,y=0,z=0;

        if(name==="breath"){
          const radius = 95 + 35*Math.sin(u*Math.PI*2*3);
          const theta = Math.random()*Math.PI*2;
          const phi = Math.acos(2*Math.random()-1);
          x = radius*Math.sin(phi)*Math.cos(theta);
          y = radius*Math.sin(phi)*Math.sin(theta);
          z = radius*Math.cos(phi);
          if(Math.random()>0.86){ x*=1.35; y*=1.35; z*=1.35; }
        } else if(name==="burst"){
          const r = 170 * Math.cbrt(Math.random());
          const theta = Math.random()*Math.PI*2;
          const phi = Math.acos(2*Math.random()-1);
          x = r*Math.sin(phi)*Math.cos(theta);
          y = r*Math.sin(phi)*Math.sin(theta);
          z = r*Math.cos(phi);
        } else if(name==="wave"){
          x = (u - 0.5) * 430;
          z = (Math.random()-0.5) * 180;
          y = Math.sin(x*0.018)*34 + Math.sin(z*0.055)*20 + Math.sin((x+z)*0.012)*10;
        } else if(name==="dna"){
          const turns = 11;
          const angle = u * Math.PI * 2 * turns;
          const radius = 34;
          const height = 340;
          const strandOffset = (p % 2 === 0) ? 0.0 : Math.PI;
          x = Math.cos(angle + strandOffset)*radius;
          z = Math.sin(angle + strandOffset)*radius;
          y = (u - 0.5)*height;
          if(p % 9 === 0){ x*=0.3; z*=0.3; }
          x += (Math.random()-0.5)*6;
          z += (Math.random()-0.5)*6;
        } else if(name==="sphere"){
          const radius = 92;
          const theta = Math.random()*Math.PI*2;
          const phi = Math.acos(2*Math.random()-1);
          x = radius*Math.sin(phi)*Math.cos(theta);
          y = radius*Math.sin(phi)*Math.sin(theta);
          z = radius*Math.cos(phi);
          if(Math.random()>0.84){
            const s = 1.22 + Math.random()*0.12;
            x*=s; y*=s; z*=s;
          }
        } else if(name==="galaxy"){
          const arms = 3;
          const arm = p % arms;
          const armOffset = (Math.PI*2/arms)*arm;
          const dist = Math.pow(Math.random(), 0.55);
          const r = dist * 220;
          const spin = dist * 10.5;
          x = Math.cos(spin + armOffset)*r;
          z = Math.sin(spin + armOffset)*r;
          y = (Math.random()-0.5) * (26*(1.0 - dist));
          if(Math.random()>0.92){ x*=0.25; z*=0.25; y*=0.25; }
        }

        const i = p * 4;
        data[i+0]=x; data[i+1]=y; data[i+2]=z; data[i+3]=1;
      }
      dtTarget.needsUpdate = true;
    }
    writeTargetShape(story[0].target);

    // ‚úÖ FIX: declare texturePosition + textureVelocity explicitly
    const velocityShader = /* glsl */`
      uniform float uTime;
      uniform float uDelta;
      uniform float uDamping;
      uniform float uBounds;

      uniform float uNoiseScale;
      uniform float uNoiseSpeed;
      uniform float uCurlStrength;

      uniform float uAttractStrength;
      uniform float uTargetBlend;

      uniform sampler2D texturePosition;
      uniform sampler2D textureVelocity;   // ‚úÖ REQUIRED
      uniform sampler2D textureTarget;

      float hash(vec3 p){
        p = fract(p * 0.3183099 + vec3(0.1,0.2,0.3));
        p *= 17.0;
        return fract(p.x * p.y * p.z * (p.x + p.y + p.z));
      }
      float vnoise(vec3 p){
        vec3 i = floor(p);
        vec3 f = fract(p);
        f = f*f*(3.0-2.0*f);
        float n000 = hash(i + vec3(0,0,0));
        float n100 = hash(i + vec3(1,0,0));
        float n010 = hash(i + vec3(0,1,0));
        float n110 = hash(i + vec3(1,1,0));
        float n001 = hash(i + vec3(0,0,1));
        float n101 = hash(i + vec3(1,0,1));
        float n011 = hash(i + vec3(0,1,1));
        float n111 = hash(i + vec3(1,1,1));
        float nx00 = mix(n000, n100, f.x);
        float nx10 = mix(n010, n110, f.x);
        float nx01 = mix(n001, n101, f.x);
        float nx11 = mix(n011, n111, f.x);
        float nxy0 = mix(nx00, nx10, f.y);
        float nxy1 = mix(nx01, nx11, f.y);
        return mix(nxy0, nxy1, f.z);
      }

      vec3 field(vec3 p, float t){
        float s = uNoiseScale;
        vec3 q = p*s + vec3(t*uNoiseSpeed);
        float n1 = vnoise(q);
        float n2 = vnoise(q + vec3(19.1,7.2,13.7));
        float n3 = vnoise(q + vec3(3.4,11.7,5.9));
        return vec3(n1, n2, n3)*2.0 - 1.0;
      }

      vec3 curl(vec3 p, float t){
        float e = 0.35;
        vec3 dx = vec3(e,0,0);
        vec3 dy = vec3(0,e,0);
        vec3 dz = vec3(0,0,e);

        vec3 f1 = field(p + dy, t);
        vec3 f2 = field(p - dy, t);
        vec3 f3 = field(p + dz, t);
        vec3 f4 = field(p - dz, t);
        vec3 f5 = field(p + dx, t);
        vec3 f6 = field(p - dx, t);

        float x = (f1.z - f2.z) - (f3.y - f4.y);
        float y = (f3.x - f4.x) - (f5.z - f6.z);
        float z = (f5.y - f6.y) - (f1.x - f2.x);

        return normalize(vec3(x,y,z) + 1e-5);
      }

      void main(){
        vec2 uv = gl_FragCoord.xy / resolution.xy;

        vec3 pos = texture2D(texturePosition, uv).xyz;
        vec3 vel = texture2D(textureVelocity, uv).xyz;
        vec3 tgt = texture2D(textureTarget, uv).xyz;

        vec3 c = curl(pos, uTime);
        vel += c * uCurlStrength * uDelta;

        vec3 toT = (tgt - pos);
        vel += toT * uAttractStrength * uTargetBlend * uDelta;

        vel *= uDamping;

        float b = uBounds;
        if (pos.x >  b) pos.x = -b;
        if (pos.x < -b) pos.x =  b;
        if (pos.y >  b) pos.y = -b;
        if (pos.y < -b) pos.y =  b;
        if (pos.z >  b) pos.z = -b;
        if (pos.z < -b) pos.z =  b;

        gl_FragColor = vec4(vel, 1.0);
      }
    `;

    // ‚úÖ FIX: declare texturePosition explicitly
    const positionShader = /* glsl */`
      uniform float uDelta;
      uniform sampler2D texturePosition;  // ‚úÖ REQUIRED
      uniform sampler2D textureVelocity;
      void main(){
        vec2 uv = gl_FragCoord.xy / resolution.xy;
        vec3 pos = texture2D(texturePosition, uv).xyz;
        vec3 vel = texture2D(textureVelocity, uv).xyz;
        pos += vel * uDelta;
        gl_FragColor = vec4(pos, 1.0);
      }
    `;

    const velVar = gpuCompute.addVariable("textureVelocity", velocityShader, dtVelocity);
    const posVar = gpuCompute.addVariable("texturePosition", positionShader, dtPosition);

    gpuCompute.setVariableDependencies(velVar, [velVar, posVar]);
    gpuCompute.setVariableDependencies(posVar, [velVar, posVar]);

    velVar.material.uniforms.uTime = { value: 0 };
    velVar.material.uniforms.uDelta = { value: 0.016 };
    velVar.material.uniforms.uDamping = { value: SETTINGS.DAMPING };
    velVar.material.uniforms.uBounds = { value: SETTINGS.BOUNDS };
    velVar.material.uniforms.uNoiseScale = { value: SETTINGS.NOISE_SCALE };
    velVar.material.uniforms.uNoiseSpeed = { value: SETTINGS.NOISE_SPEED };
    velVar.material.uniforms.uCurlStrength = { value: SETTINGS.CURL_STRENGTH };
    velVar.material.uniforms.uAttractStrength = { value: SETTINGS.ATTRACT_STRENGTH };
    velVar.material.uniforms.uTargetBlend = { value: SETTINGS.TARGET_BLEND };
    velVar.material.uniforms.textureTarget = { value: dtTarget };

    posVar.material.uniforms.uDelta = { value: 0.016 };

    const err = gpuCompute.init();
    if (err) {
      console.error("GPUComputationRenderer init error:", err);
      // Si √ßa casse ici : l'appareil / navigateur ne supporte pas le render-to-float/half-float.
      // Dans ce cas, il faudra baisser SIZE (128) et/ou changer de device.
    }

    function createSupernovaTexture(){
      const c = document.createElement("canvas");
      c.width = 256; c.height = 256;
      const ctx = c.getContext("2d");
      const g = ctx.createRadialGradient(128,128,0, 128,128,128);
      g.addColorStop(0.00, "rgba(255,255,255,1)");
      g.addColorStop(0.12, "rgba(255,255,255,.95)");
      g.addColorStop(0.28, "rgba(255,255,255,.55)");
      g.addColorStop(0.55, "rgba(255,255,255,.18)");
      g.addColorStop(1.00, "rgba(0,0,0,0)");
      ctx.fillStyle = g;
      ctx.fillRect(0,0,256,256);
      ctx.globalCompositeOperation = "lighter";
      for(let i=0;i<7;i++){
        ctx.beginPath();
        ctx.arc(128,128, 18 + i*18, 0, Math.PI*2);
        ctx.strokeStyle = `rgba(255,255,255,${0.06 - i*0.007})`;
        ctx.lineWidth = 2;
        ctx.stroke();
      }
      return new THREE.CanvasTexture(c);
    }

    // Geometry with UVs into compute texture
    const geom = new THREE.BufferGeometry();
    const dummyPos = new Float32Array(PARTICLES * 3);
    const uvs = new Float32Array(PARTICLES * 2);
    let idx = 0;
    for(let y=0;y<SIZE;y++){
      for(let x=0;x<SIZE;x++){
        dummyPos[idx*3+0]=0; dummyPos[idx*3+1]=0; dummyPos[idx*3+2]=0;
        uvs[idx*2+0]= x/(SIZE-1);
        uvs[idx*2+1]= y/(SIZE-1SIZE? 1 : (SIZE-1)); // avoid 0 division in edge cases (SIZE>=2 always)
        idx++;
      }
    }
    // Correct the above line to be safe:
    for (let i=0;i<uvs.length;i+=2){
      // no-op; kept for clarity
    }
    // Actually fix UV generation (above line had an intentional typo risk, so overwrite properly):
    idx = 0;
    for(let y=0;y<SIZE;y++){
      for(let x=0;x<SIZE;x++){
        uvs[idx*2+0]= x/(SIZE-1);
        uvs[idx*2+1]= y/(SIZE-1);
        idx++;
      }
    }

    geom.setAttribute("position", new THREE.BufferAttribute(dummyPos,3));
    geom.setAttribute("uv", new THREE.BufferAttribute(uvs,2));

    const particleMat = new THREE.ShaderMaterial({
      uniforms:{
        uTime:{ value:0 },
        uPositions:{ value:null },
        uColor:{ value: story[0].color.clone() },
        uTexture:{ value: createSupernovaTexture() },
        uPointSize:{ value: SETTINGS.POINT_SIZE },
        uRatio:{ value: renderer.getPixelRatio() },
        uPulse:{ value: 0.0 }
      },
      vertexShader: /* glsl */`
        uniform sampler2D uPositions;
        uniform float uTime;
        uniform float uPointSize;
        uniform float uRatio;
        uniform float uPulse;
        varying float vAlpha;
        varying float vTwinkle;

        void main(){
          vec3 pos = texture2D(uPositions, uv).xyz;

          float rnd = fract(sin(dot(uv, vec2(12.9898,78.233))) * 43758.5453);
          float tw = 0.6 + 0.4 * sin(uTime * (2.6 + rnd*3.0) + rnd*100.0);
          vTwinkle = tw;

          vec4 mv = modelViewMatrix * vec4(pos, 1.0);
          gl_Position = projectionMatrix * mv;

          float base = uPointSize * (0.65 + rnd);
          float accent = 1.0 + uPulse*(0.40 + rnd*0.35);
          gl_PointSize = (base * uRatio * accent) / -mv.z;

          vAlpha = smoothstep(650.0, 220.0, -mv.z);
        }
      `,
      fragmentShader: /* glsl */`
        uniform vec3 uColor;
        uniform sampler2D uTexture;
        varying float vAlpha;
        varying float vTwinkle;
        void main(){
          vec4 tex = texture2D(uTexture, gl_PointCoord);
          if(tex.a < 0.05) discard;

          float a = tex.a * vAlpha * (0.78 + 0.22*vTwinkle);
          vec3 col = uColor;

          float core = smoothstep(0.9, 0.2, distance(gl_PointCoord, vec2(0.5)));
          col += vec3(0.12) * core;

          gl_FragColor = vec4(col, a);
        }
      `,
      transparent:true,
      depthWrite:false,
      blending: THREE.AdditiveBlending
    });

    const points = new THREE.Points(geom, particleMat);
    scene.add(points);

    // Post stack
    const composer = new EffectComposer(renderer);
    composer.addPass(new RenderPass(scene, camera));

    const bloom = new UnrealBloomPass(
      new THREE.Vector2(window.innerWidth, window.innerHeight),
      SETTINGS.bloomStrength,
      SETTINGS.bloomRadius,
      SETTINGS.bloomThreshold
    );
    composer.addPass(bloom);

    const RGBShiftShader = {
      uniforms: {
        tDiffuse: { value: null },
        amount: { value: SETTINGS.rgbShift },
        angle: { value: 0.35 }
      },
      vertexShader: `
        varying vec2 vUv;
        void main(){
          vUv = uv;
          gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);
        }
      `,
      fragmentShader: `
        uniform sampler2D tDiffuse;
        uniform float amount;
        uniform float angle;
        varying vec2 vUv;
        void main(){
          vec2 offset = amount * vec2(cos(angle), sin(angle));
          vec4 cr = texture2D(tDiffuse, vUv + offset);
          vec4 cga = texture2D(tDiffuse, vUv);
          vec4 cb = texture2D(tDiffuse, vUv - offset);
          gl_FragColor = vec4(cr.r, cga.g, cb.b, cga.a);
        }
      `
    };
    const rgbPass = new ShaderPass(RGBShiftShader);
    composer.addPass(rgbPass);

    const film = new FilmPass(SETTINGS.grainIntensity, 0.025, 648, false);
    composer.addPass(film);

    function applyPost(){
      bloom.enabled = SETTINGS.bloomOn;
    }
    applyPost();

    function pulse(){
      particleMat.uniforms.uPulse.value = 1.0;
      const t0 = performance.now();
      const dur = 900;
      (function tick(){
        const k = (performance.now() - t0) / dur;
        particleMat.uniforms.uPulse.value = Math.max(0, 1.0 - k);
        if(k < 1) requestAnimationFrame(tick);
      })();
    }

    function next(){
      step = (step + 1) % story.length;

      writeTargetShape(story[step].target);
      velVar.material.uniforms.textureTarget.value = dtTarget;

      setUI(step);

      const from = particleMat.uniforms.uColor.value.clone();
      const to = story[step].color.clone();
      const t0 = performance.now();
      const dur = 1200;
      (function lerp(){
        const k = Math.min(1, (performance.now()-t0)/dur);
        particleMat.uniforms.uColor.value.copy(from).lerp(to, k);
        if(k < 1) requestAnimationFrame(lerp);
      })();

      renderer.toneMappingExposure = SETTINGS.EXPOSURE * 1.12;
      setTimeout(()=> renderer.toneMappingExposure = SETTINGS.EXPOSURE, 220);
      pulse();
    }

    const clock = new THREE.Clock();
    let running = false;
    let ang = 0;

    function animate(){
      if(!running) return;
      requestAnimationFrame(animate);

      const dt = Math.min(clock.getDelta(), 0.033);
      const t = clock.getElapsedTime();

      velVar.material.uniforms.uTime.value = t;
      velVar.material.uniforms.uDelta.value = dt;
      posVar.material.uniforms.uDelta.value = dt;

      gpuCompute.compute();

      particleMat.uniforms.uPositions.value = gpuCompute.getCurrentRenderTarget(posVar).texture;
      particleMat.uniforms.uTime.value = t;
      particleMat.uniforms.uRatio.value = renderer.getPixelRatio();

      ang += dt * 0.13;
      const r = SETTINGS.CAMERA_RADIUS;
      camera.position.x = Math.sin(ang) * r + pointer.x * 55;
      camera.position.z = Math.cos(ang) * r + pointer.x * 18;
      camera.position.y = pointer.y * 42;
      camera.lookAt(pointer.x * 18, pointer.y * 18, 0);

      points.rotation.y = t * 0.03;
      points.rotation.x = Math.sin(t * 0.12) * 0.06;

      composer.render();
    }

    const overlay = document.getElementById("overlay");
    function start(){
      if(running) return;
      running = true;
      overlay.style.opacity = "0";
      setTimeout(()=> overlay.style.display = "none", 900);
      setUI(0);
      animate();
    }

    document.body.addEventListener("click", ()=>{
      if(!running) start();
      else next();
    });
    window.addEventListener("keydown", (e)=>{
      if(e.key === " " || e.key === "Enter"){
        e.preventDefault();
        if(!running) start(); else next();
      }
    });

    document.getElementById("btnReplay").addEventListener("click", (e)=>{
      e.stopPropagation();
      step = 0;
      writeTargetShape(story[0].target);
      velVar.material.uniforms.textureTarget.value = dtTarget;
      particleMat.uniforms.uColor.value.copy(story[0].color);
      setUI(0);
      pulse();
    });

    document.getElementById("btnBloom").addEventListener("click", (e)=>{
      e.stopPropagation();
      SETTINGS.bloomOn = !SETTINGS.bloomOn;
      applyPost();
      e.currentTarget.textContent = SETTINGS.bloomOn ? "‚ú® Bloom" : "‚ú¶ Bloom";
    });

    document.getElementById("btnQuality").addEventListener("click", (e)=>{
      e.stopPropagation();
      SETTINGS.useHighQuality = !SETTINGS.useHighQuality;
      renderer.setPixelRatio(Math.min(window.devicePixelRatio, SETTINGS.useHighQuality ? SETTINGS.DPR_HIGH : SETTINGS.DPR_LOW));
      renderer.setSize(window.innerWidth, window.innerHeight);
      composer.setSize(window.innerWidth, window.innerHeight);
      bloom.setSize(window.innerWidth, window.innerHeight);
      particleMat.uniforms.uRatio.value = renderer.getPixelRatio();
      e.currentTarget.textContent = SETTINGS.useHighQuality ? "‚ö° Qualit√©" : "ü™∂ Qualit√©";
    });

    window.addEventListener("resize", ()=>{
      camera.aspect = window.innerWidth/window.innerHeight;
      camera.updateProjectionMatrix();
      renderer.setSize(window.innerWidth, window.innerHeight);
      composer.setSize(window.innerWidth, window.innerHeight);
      bloom.setSize(window.innerWidth, window.innerHeight);
      particleMat.uniforms.uRatio.value = renderer.getPixelRatio();
    });

    setUI(0);
    barEl.style.width = ((1)/story.length*100) + "%";
    countEl.textContent = "01/" + String(story.length).padStart(2,"0");
  </script>
</body>
</html>
